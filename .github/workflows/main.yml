name: Ultimate 1.12.14 Stable Build (Module Fixed)
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-14
    steps:
      # 1. ğŸŸ¢ å¼ºè¡Œç¯å¢ƒå¯¹ä½ (Java 17 & Go)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # 2. ğŸŸ¢ å¹²å‡€æ‹‰å–å…¨å¥—æºç  (v1.12.14 ç¨³å®šç‰ˆ)
      - name: Clone Clean Source
        run: |
          git clone https://github.com/SagerNet/sing-box-for-apple.git main-app
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git core-src

      # 3. ğŸŸ¢ æ ¸å¿ƒç¼–è¯‘ï¼šä½¿ç”¨â€œåŒ…è·¯å¾„â€æ¨¡å¼ï¼Œè§£å†³ go.mod ç¼ºå¤±é—®é¢˜
      - name: Build Core Framework (Package Mode)
        run: |
          # å®‰è£…ç¼–è¯‘å·¥å…·
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          # ğŸ”´ æ ¸å¿ƒä¿®å¤ï¼šè¿›å…¥åŒ…å« go.mod çš„æºç æ ¹ç›®å½•æ‰§è¡Œç¼–è¯‘
          cd core-src
          
          # åŠ¨æ€å¯»æ‰¾åŒ…å« apple ç¼–è¯‘é€»è¾‘çš„å…·ä½“åŒ…è·¯å¾„
          APPLE_PACKAGE=$(find cmd/apple -name "main.go" -o -name "apple.go" | head -n 1 | xargs dirname)
          echo "Compiling package: ./$APPLE_PACKAGE"
          
          # ä½¿ç”¨ go run æŒ‡å‘å…·ä½“åŒ…ï¼Œå¹¶ç”Ÿæˆ framework
          go run ./$APPLE_PACKAGE framework -v
          
          # æ¬è¿ç”Ÿæˆçš„ xcframework åˆ° App ç›®å½•
          cd $GITHUB_WORKSPACE
          mkdir -p main-app/Library/sing-box
          find core-src -name "*.xcframework" -exec cp -rf {} main-app/Library/sing-box/ \;

      # 4. ğŸŸ¢ æœ€ç»ˆ Xcode åˆæˆ
      - name: Final Xcode Synthesis
        run: |
          cd main-app
          # å‰”é™¤å¹²æ‰°é¡¹
          rm -rf Extension IntentsExtension WidgetExtension TVExtension
          # å¼ºè¡Œæ„å»ºæ— ç­¾å IPA
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     FRAMEWORK_SEARCH_PATHS="$(pwd)/Library/sing-box" \
                     clean archive -archivePath build/sing-box.xcarchive

      # 5. ğŸŸ¢ æ‰“åŒ…ä¸äº§å‡º
      - name: Export for TrollStore
        run: |
          mkdir -p Payload
          APP_PATH=$(find main-app/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-stable.ipa Payload/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-1.12.14-Success
          path: sing-box-1.12.14-stable.ipa
