name: Ultimate 1.12.14 Stable Build
on: workflow_dispatch

jobs:
  build:
    runs-on: macos-14
    steps:
      # 1. ğŸŸ¢ å¼ºè¡Œå¯¹ä½ Java 17 ç¯å¢ƒ (è§£å†³ä½ ä¹‹å‰çš„ FATAL æŠ¥é”™)
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      # 2. ğŸŸ¢ é…ç½® Go ç¼–è¯‘ç¯å¢ƒ
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      # 3. ğŸŸ¢ ç»•è¿‡æ‰€æœ‰æ—§è·¯å¾„ï¼šåœ¨è™šæ‹Ÿæœºé‡Œé‡å»ºçº¯å‡€æºç 
      - name: Clone Clean Source
        run: |
          # å…‹éš†ä¸» App (UIéƒ¨åˆ†)
          git clone https://github.com/SagerNet/sing-box-for-apple.git main-app
          # å…‹éš†æŒ‡å®š 1.12.14 å†…æ ¸ (æ ¸å¿ƒéƒ¨åˆ†)
          git clone --branch v1.12.14 --depth 1 https://github.com/SagerNet/sing-box.git core-src

      # 4. ğŸŸ¢ ç°åœºâ€œç£¨åˆ¶â€ 1.12.14 æ ¸å¿ƒé›¶ä»¶
      - name: Build Core Framework
        run: |
          go install github.com/sagernet/gomobile/cmd/gomobile@latest
          go install github.com/sagernet/gomobile/cmd/gobind@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
          $(go env GOPATH)/bin/gomobile init
          
          # è¿›å…¥å†…æ ¸ç›®å½•å¹¶å¼€å§‹é«˜å¼ºåº¦ç¼–è¯‘
          cd core-src/cmd/apple
          go run . framework -v
          
          # å°†ç”Ÿæˆçš„æœ€æ–°é›¶ä»¶ç‰©ç†æ¬è¿åˆ° App é¡¹ç›®ä¸­
          mkdir -p ../../../main-app/Library/sing-box
          cp -rf *.xcframework ../../../main-app/Library/sing-box/

      # 5. ğŸŸ¢ æœ€ç»ˆåˆæˆ IPA
      - name: Final Xcode Synthesis
        run: |
          cd main-app
          # å½»åº•å‰”é™¤å¹²æ‰°è¯ä¹¦æŠ¥é”™çš„æ’ä»¶
          rm -rf Extension IntentsExtension WidgetExtension TVExtension
          # å¼ºè¡Œæ„å»ºæ— ç­¾åçš„ IPA
          xcodebuild -project sing-box.xcodeproj \
                     -scheme SFI \
                     -configuration Release \
                     -sdk iphoneos \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     FRAMEWORK_SEARCH_PATHS="$(pwd)/Library/sing-box" \
                     clean archive -archivePath build/sing-box.xcarchive

      # 6. ğŸŸ¢ æ‰“åŒ…å¹¶äº§å‡º
      - name: Export for TrollStore
        run: |
          mkdir -p Payload
          APP_PATH=$(find main-app/build/sing-box.xcarchive -name "*.app" | head -n 1)
          cp -rp "$APP_PATH" Payload/
          zip -r sing-box-1.12.14-stable.ipa Payload/

      - name: Upload Finished IPA
        uses: actions/upload-artifact@v4
        with:
          name: SingBox-Stable-Result
          path: sing-box-1.12.14-stable.ipa
